<head>
	<script src='http://code.jquery.com/jquery-latest.min.js' type="text/javascript" ></script>
	<script src="http://malsup.github.com/jquery.form.js" type="text/javascript"></script> 
	<script 
	src="https://rawgithub.com/paperjs/paper.js/master/dist/paper-full.min.js" type="text/javascript">
	</script> 
	
	<script type="text/paperscript" canvas="my_canvas">
		var ocfu_result=[];
		var canvas_dim = new Point(512,512);
		var margin_dim = new Point(16,16);
		var img_dim = new Point(0,0);
		var count = -1;
		var rast_mat;
		
		function redraw(){
			var rectangle = new Rectangle(new Point(0,0), canvas_dim*2);
			var path = new Path.Rectangle(rectangle);
			path.fillColor = '#000000';
			var raster = new Raster('my_img');
			img_dim = new Point(raster.width,raster.height);
			tmp_r = (canvas_dim - margin_dim) / img_dim
			if (tmp_r.x > tmp_r.y)
				raster.scale(tmp_r.y);
			else
				raster.scale(tmp_r.x);
			raster.position = canvas_dim/2;
			rast_mat = raster.matrix;
		}
		function readURL(input) {
			if (input.files && input.files[0]) {
				console.log(input.files[0]);
				var reader = new FileReader();
				reader.onload = function (e) {
					$('#my_img').attr('src', e.target.result);
					redraw();
					}
			reader.readAsDataURL(input.files[0]);
			}
		}
		function processJson(data) { 
			ocfu_result = data;
			redraw();
			count=0;
			for (var i = 0; i < ocfu_result.data.length; i++) {
				
				p = new Point(ocfu_result.data[i][1],ocfu_result.data[i][2]);
				valid = ocfu_result.data[i][0];
				rad = ocfu_result.data[i][6];
				p = p - (img_dim /2);
				var my_circle = new Path.Circle(p,rad);
				var my_circle2 = new Path.Circle(p,rad);
				my_circle = my_circle.transform(rast_mat);
				my_circle2 = my_circle2.transform(rast_mat);
				
				if(valid > 0){
					my_circle.strokeColor ='#0000ff';
					my_circle2.strokeColor ='#ffff00';
					count++;
				}
				else{
					my_circle.strokeColor ='#ff0000';
					
				}
				
				my_circle.strokeWidth = 2;
				my_circle2.strokeWidth = 1;
			}
			$('#result').text("#Objects = "+count);
		}
		$(document).ready(function() { 
			$('#my_form').ajaxForm({ 
				dataType:  'json', 
				success:   processJson 
			});
			$("#id_file").change(function(){readURL(this);});
		});

	</script>
</head>
<body>


		
		<form id="my_form" action="counting/" method="post" 
		{% if form.is_multipart %} 
		enctype="multipart/form-data"{% endif %}>
			{% csrf_token %}
			{{ form.as_p }}
			<input type="submit" value="Submit"/>
		</form>
		<div id="result_frame"></div>
		
		<h2 id="result"></h2>
		
<canvas id="my_canvas" width="512px" height="512px" style="border:3px solid #000000;">
	<img id="my_img" src="#" alt="your image" />
</canvas>
</body>
